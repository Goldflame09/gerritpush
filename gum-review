#!/bin/bash

###################################################################
#                                                                 #
# Created by Sniper/Goldflame09/wedgess/Papa Smurf151 for Gummy   #
#                                                                 #
###################################################################

VERSION=0.1
BUILD=1

set_up_user(){
if [ -f ${HOME}/.gum/username ]; then
   GUZER=`cat ${HOME}/.gum/username`
else
   echo -n "Please enter your Gerrit UserName: "; read GUZER
   echo "Your entered ${GUZER} is this correct"
   echo "Enter 1 for Yes or 2 for No"
   select correct1 in "Yes" "No"; do
   case ${correct1} in
        Yes ) mkdir -p ${HOME}/.gum;
              echo ${GUZER} > ${HOME}/.gum/username;
              echo "Your new gerrit username is: ${GUZER}"; break;;
        No ) echo -n "Re-Enter Gerrit UserName: "; read GUZER; echo; mkdir -p ${HOME}/.gum; echo ${GUZER} > ${HOME}/.gum/username; echo "Your new gerrit username is: ${GUZER}"; break;;
        *) clear; echo "Invalid Entry ${correct1}, Please enter a number between [1 - 2]"; echo; set_up_user; break;;
   esac
 done
fi
}

correct_commit() {
clear; echo ${MSSG}; echo
echo "Is this correct ??"
echo "Enter 1 for Yes and 2 for No"
  select correct2 in "Yes" "No"; do
   case ${correct2} in
	Yes ) echo "Commit set to ${MSSG}"; break;;
	No ) echo "Re-enter commit message"; read MSSG; break;;
	* ) clear; echo "Invalid Entry ${correct2}, Please re-try"; echo; echo; correct_commit; break ;;
   esac
  done
}

ap () {
git add -A
scp -p -P 29418 ${GUZER}@review.gummyrom.com:hooks/commit-msg .git/hooks/
   echo "Add commit message below.
--------------------------"
   read MSSG
   correct_commit
git commit -a -m "${MSSG}"
push
}


push () {
echo -n "Are you sure you want to push? (y/n): "; read RESP
if [ "${RESP}" == "y" ] || [ "${RESP}" == "Y" ]; then
    PROJECT=`grep TEAM-Gummy .git/config | awk -F/ '{print $NF}'`
    git push ssh://${GUZER}@review.gummyrom.com:29418/TEAM-Gummy/${PROJECT} HEAD:refs/\for/jb4.3
else
  echo "Canceled"
fi
}


amend () {
   echo -n "Have you edited the files?/Do you want to change commit message? (y/n):"; read RESPa
if [ "${RESPa}" == "y" ] || [ "${RESPa}" == "Y" ]; then
   git add -A
   git commit --amend
   push
elif [ "${RESPa}" == "n" ] || [ "${RESPa}" == "N" ]; then
	echo "Please edit them"
	echo "Press 1 after you edit them"
	read amend1
	if [ ${amend1} == "1" ]; then
		git add -A
		git commit --amend
		push
	else
		echo "Take your time and come back when you are ready"
	fi
fi
}


correct_gname() {
echo "Your entered ${GUZER} is this correct?"
echo "Enter 1 for Yes and 2 for No"
   select correct1 in "Yes" "No"; do
   case ${correct1} in
	Yes ) mkdir ${HOME}/.gum; echo ${GUZER} > ${HOME}/.gum/username; echo "Your new gerrit username is: ${GUZER}"; break;;
	No ) echo -n "Re-Enter Gerrit UserName: "; read GUZER; echo; mkdir -p ${HOME}/.gum; echo ${GUZER} > ${HOME}/.gum/username; echo "Your new gerrit username is: ${GUZER}"; break;;
	* ) clear; echo "Invalid Entry ${correct1}, Please re-try"; echo; echo; correct_gname break ;;
   esac
  done
}


nameq_question() {
  select NAME in "View" "New"; do
   case ${NAME} in
      View ) if [ -f ${HOME}/.gum/username ]; then
           echo "Your current gerrit username is: ${GUZER}";
	  else
	   echo "No gerrit username found..";
	  fi; break;;
      New ) echo -n "Enter your new gerrit username: "; read GUZER; correct_gname; break;;
      * ) clear; echo "${NAME} is not a valid option (Choose 1 or 2)"; nameq_question; break;;
   esac
  done
}


name () {
   echo "Enter an option:"
   echo "   1. View your current gerrit username"
   echo "   2. Enter a new gerrit username"
   echo; nameq_question
}


sshkey () {
if [ -e ${HOME}/.ssh/id_rsa.pub ]; then
   echo "SSH Key already exists.

Go to Gummy Gerrit (http://review.gummyrom.com), sign in, go to settings, 
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open ${HOME}/.ssh/id_rsa.pub
else
   ssh-keygen
   echo "Go to Gummy Gerrit (http://review.gummyrom.com), sign in, go to settings, 
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open ${HOME}/.ssh/id_rsa.pub
fi
}

ask_the_question() {
echo -n "Are you sure you want to update to version: ${NEWV} build: ${NEWB}? (yes/no)"
select correct4 in "Yes" "No"; do
  case ${correct4} in
      Yes ) rm -f ${HOME}/.gum/pac-review; mv ${HOME}/.gum/.new ${HOME}/bin/pac-review; chmod +x ${HOME}/bin/pac-review; echo; echo "Successfully updated to v${NEWV}!"; break;;
      No ) echo "Update canceled"; break ;;
      * ) clear; echo "Invalid option ${correct4}, Please try again..."; echo; ask_the_question; break;;
   esac
done
}

error () {
   echo " "
   echo "Usage: pac-review [-short command]"
   echo "Or:    pac-review [long comand]"
   echo " "
   echo "Commands:"
   echo "   add+push   	(-ap)  --- Add and push to gerrit"
   echo "   amend  	(-am)  --- Amend the commit and push"
   echo "   name   	(-n)   --- View or edit your gerrit username"
   echo "   push   	(-p)   --- Push to gerrit"
   echo "   sshkey 	(-ssh) --- Create/show SSH key to put on Gerrit"

   echo " "
   echo "If you encounter problems, check if:"
   echo "   1. Your gerrit username is correct (using the name option)"
   echo "   2. Your current branch is correct"
   echo "   3. Your public ssh key is attached to your gerrit profile"
   echo " "

}


if [ ! -d ${HOME}/bin ]; then
 mkdir -p ${HOME}/bin
 echo "# Add ~/bin to PATH" >> ${HOME}/.bashrc
 echo "export PATH=${PATH}:~/bin" >> ${HOME}/.bashrc
fi

set_up_user

case $1 in
   -n|name)name;;
   -p|push)push;;
   -ssh|sshkey)sshkey;;
   -ap|add+push)ap;;
   -am|amend)amend;;
   -h|help|*)error;;
esac
