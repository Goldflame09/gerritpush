#!/bin/bash

###################################################################
# #
# Created by Sniper/Goldflame09/wedgess/Papa Smurf151 for PAC-man #
# #
###################################################################

VERSION=1.0
BUILD=1

# Variable matrix
TEAM=("AOKP" "Carbon" "Chameleon-OS" "CyanogenMod" "Dirty-Unicorns" "Gummy" "Omni" "Paraniod-Android" "PAC" "Vanir")
GTEAM=("gerrit.aokp.co" "review.carbon-rom.com" "review.chameleonos.org" "review.cyanogenmod.org" "gerrit.dirtyunicorns.com" "review.gummyrom.com" "gerrit.omnirom.org" "gerrit.paranoidandroid.co" "review.pac-rom.com" "vaniraosp.goo.im")
URL=(":29418/AOKP/" ":29418/CarbonDev/" ":29418/ChameleonOS/" ":29418/CyanogenMod/" ":29418/" ":29418/TEAM-Gummy/" ":29418/" ":29418/ParanoidAndroid/" ":29418/" ":29418/")

set_up_user(){
safety=`cat ${HOME}/.gerritpush/safety`

if [ -f ${HOME}/.gerritpush/username ]; then
   GUZER=`cat ${HOME}/.gerritpush/username`
else
   clear
   echo -n "Please enter your Gerrit UserName: "; read GUZER; clear
   if [ ${safety} -eq "1" ]; then
		echo "Your entered ${GUZER} is this correct"
		echo "Enter 1 for Yes or 2 for No"
		select correct1 in "Yes" "No"; do
			case ${correct1} in
				Yes ) mkdir -p ${HOME}/.gerritpush;
					echo ${GUZER} > ${HOME}/.gerritpush/username;
					clear; echo "Your new gerrit username is: ${GUZER}"; echo; break;;
				No ) clear; echo -n "Re-Enter Gerrit UserName: "; read GUZER; echo; mkdir -p ${HOME}/.gerritpush; echo ${GUZER} > ${HOME}/.gerritpush/username; clear; echo "Your new gerrit username is: ${GUZER}"; echo; break;;
				*) clear; echo "Invalid Entry ${correct1}, Please enter a number between [1 - 2]"; echo; set_up_user; break;;
			esac
		done
	else
		mkdir -p ${HOME}/.gerritpush;
		echo ${GUZER} > ${HOME}/.gerritpush/username;
		clear;
	fi
fi
}

team() {
        if [ -f ${HOME}/.gerritpush/team ]; then
                GTEAM=`cat ${HOME}/.gerritpush/team`
                TEAM=`cat ${HOME}/.gerritpush/teamCHOICE`
				if [ -f ${HOME}/.gerritpush/gerritURL ]; then
					GURL=`cat ${HOME}/.gerritpush/gerritURL`
				fi
        else
                new_team
        fi
}


new_team() {
				if [ -f ${HOME}/.gerritpush/team ]; then
                        DisplayTeam=`cat ${HOME}/.gerritpush/teamCHOICE`
                        echo ""
                        echo "###################################################################"
                        echo ""
                        echo "Your gerrit team is set to: ${DisplayTeam}"
                        echo ""
                        echo "###################################################################"
                        echo ""
                fi
                echo "Please Select your new Gerrit Team:"
                echo "Enter the Corresponding Number"
                select NUMBER in $(echo ${TEAM[@]}); do
                	case ${NUMBER} in
							AOKP) i=0; break;;
                        	Carbon) i=1; break;;
                        	Chameleon-OS) i=2; break;;
                        	CyanogenMod) i=3; break;;
                        	Dirty-Unicorns) i=4; break;;
                        	Gummy) i=5; break;;
                        	Omni) i=6; break;;
                        	Paranoid-Android) i=7; break;;
                        	PAC) i=8; break;;
                        	Vanir) i=9; break;;
                        	*) echo "Invalid Entry ${NUMBER}, Please enter from the options provided."; echo; echo; team; break;;
                	esac
                done
        rm -f ${HOME}/.gerritpush/team
        rm -f ${HOME}/.gerritpush/teamCHOICE
        rm -f ${HOME}/.gerritpush/projectNAME
        rm -f ${HOME}/.gerritpush/gerritURL
        mkdir -p ${HOME}/.gerritpush; echo ${GTEAM[$i]} > ${HOME}/.gerritpush/team;
        mkdir -p ${HOME}/.gerritpush; echo ${TEAM[$i]} > ${HOME}/.gerritpush/teamCHOICE;
        mkdir -p ${HOME}/.gerritpush; echo ${URL[$i]} > ${HOME}/.gerritpush/gerritURL;
	sleep 2;echo
        clear; echo "Default Set to ${TEAM}"; echo
        
}


correct_commit() {
clear; echo ${MSSG}; echo
echo "Is this correct ??"
echo "Enter 1 for Yes and 2 for No"
  select correct2 in "Yes" "No"; do
   case ${correct2} in
        Yes ) echo "Commit set to ${MSSG}"; break;;
        No ) echo "Re-enter commit message"; read MSSG; break;;
        * ) clear; echo "Invalid Entry ${correct2}, Please re-try"; echo; echo; correct_commit; break ;;
   esac
  done
}


push() {
safety=`cat ${HOME}/.gerritpush/safety`

if [ ${safety} -eq "1" ]; then
	echo -n "Are you sure you want to push? (y/n): "; read RESP
	if [ "${RESP}" == "y" ] || [ "${RESP}" == "Y" ]; then
              	GUZER=`cat ${HOME}/.gerritpush/username`
	 	GTEAM=`cat ${HOME}/.gerritpush/team`
		BRANCH=`git branch | sed -n '/\* /s///p'`
                GURL=`cat ${HOME}/.gerritpush/gerritURL`
		PROJECT=`grep "projectname" .git/config | awk -F"projectname = " '{print $2}' | sed -e 's/^[ \t]*//' `
		if [ -z ${PROJECT} ]; then
			PROJECT=`grep "url" .git/config | awk -F"url = " '{print $2}' | rev | cut -d/ -f1 | rev | cut -d. -f1`
		fi
                git push ssh://${GUZER}@${GTEAM}${GURL}${PROJECT} HEAD:refs/\for/${BRANCH}
	else
	echo "Canceled"
	fi
else
	GUZER=`cat ${HOME}/.gerritpush/username`
	GTEAM=`cat ${HOME}/.gerritpush/team`
	BRANCH=`git branch | sed -n '/\* /s///p'`
    	GURL=`cat ${HOME}/.gerritpush/gerritURL`					
	PROJECT=`grep "projectname" .git/config | awk -F"projectname = " '{print $2}' | sed -e 's/^[ \t]*//' `
	if [ -z ${PROJECT} ]; then
		PROJECT=`grep "url" .git/config | awk -F"url = " '{print $2}' | rev | cut -d/ -f1 | rev | cut -d. -f1`
	fi
    git push ssh://${GUZER}@${GTEAM}${GURL}${PROJECT} HEAD:refs/\for/${BRANCH}
fi
}


ap() {
safety=`cat ${HOME}/.gerritpush/safety`
git add -A
scp -p -P 29418 ${GUZER}@${GTEAM}:hooks/commit-msg .git/hooks/
	echo "Add commit message below.
--------------------------"
	read MSSG
	if [ ${safety} -eq "1" ]; then
		correct_commit
	if
git commit -a -m "${MSSG}"
push
}


amend() {
   echo -n "Have you edited the files?/Do you want to change commit message? (y/n):"; read RESPa
if [ "${RESPa}" == "y" ] || [ "${RESPa}" == "Y" ]; then
   git add -A
   git commit --amend
   push
elif [ "${RESPa}" == "n" ] || [ "${RESPa}" == "N" ]; then
        echo "Please edit them"
        echo "Press 1 after you edit them"
        read amend1
        if [ ${amend1} == "1" ]; then
                git add -A
                git commit --amend
                push
        else
                echo "Take your time and come back when you are ready"
        fi
fi
}


author() {
echo "Please enter username of author"
echo -n "Username: "
read auser
git commit --amend --author ${auser}
}


correct_gname() {
echo "Your entered ${GUZER} is this correct?"
echo "Enter 1 for Yes and 2 for No"
   select correct1 in "Yes" "No"; do
   case ${correct1} in
        Yes ) mkdir ${HOME}/.gerritpush; echo ${GUZER} > ${HOME}/.gerritpush/username; echo "Your new gerrit username is: ${GUZER}"; break;;
        No ) echo -n "Re-Enter Gerrit UserName: "; read GUZER; echo; mkdir -p ${HOME}/.gerritpush; echo ${GUZER} > ${HOME}/.gerritpush/username; echo "Your new gerrit username is: ${GUZER}"; break;;
        * ) clear; echo "Invalid Entry ${correct1}, Please re-try"; echo; echo; correct_gname break ;;
   esac
  done
}


nameq_question() {
echo "Enter an option:"
echo " 1. (View) your current gerrit username"
echo " 2. Enter a (New) gerrit username"
  select NAME in "View" "New"; do
   case ${NAME} in
       View ) if [ -f ${HOME}/.gerritpush/username ]; then
           echo "Your current gerrit username is: ${GUZER}";
         else
         echo "No gerrit username found..";
         fi; break;;
      New ) echo -n "Enter your new gerrit username: "; read GUZER;
			if [ ${safety} -eq "1" ]; then
				correct_gname;
			fi; break;;
      * ) echo "${NAME} is not a valid option (Choose 1 or 2)"; nameq_question; break;;
   esac
  done
}


sshkey() {
team
echo ""
echo "Your gerrit team is set to: ${TEAM}"
echo ""
echo "You will have to set this up for every Team's Gerrit"
echo "But can use the same sshkeys for all"
echo ""
if [ -e ${HOME}/.ssh/id_rsa.pub ]; then
   echo "SSH Key already exists.

Go to ${TEAM} Gerrit (${GTEAM}), sign in, go to settings,
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open ${HOME}/.ssh/id_rsa.pub
else
   ssh-keygen
   echo "Go to ${TEAM} Gerrit (${GTEAM}), sign in, go to settings,
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open ${HOME}/.ssh/id_rsa.pub
fi
}


new() {
   curl http:/pac-rom.com/downloads/universal-review > ${HOME}/.gerritpush/.new
   sed -i '12,132d' ${HOME}/.gerritpush/.new
   NEWB=`grep BUILD= ${HOME}/.gerritpush/.new | sed "s/BUILD=//g"`
   NEWV=`grep VERSION= ${HOME}/.gerritpush/.new | sed "s/VERSION=//g"`
}

ask_the_question() {
safety=`cat ${HOME}/.gerritpush/safety`
if [ ${safety} -eq "1" ]; then
	echo -n "Are you sure you want to update to version: ${NEWV} build: ${NEWB}? (yes/no)"
	select correct4 in "Yes" "No"; do
		case ${correct4} in
			Yes ) rm -f ${HOME}/.gerritpush/universal-review; mv ${HOME}/.gerritpush/.new ${HOME}/bin/universal-review; chmod +x ${HOME}/bin/universal-review; echo; echo "Successfully updated to v${NEWV}!"; break;;
			No ) echo "Update canceled"; break ;;
			* ) clear; echo "Invalid option ${correct4}, Please try again..."; echo; ask_the_question; break;;
		esac
	done
else
	rm -f ${HOME}/.gerritpush/universal-review; mv ${HOME}/.gerritpush/.new ${HOME}/bin/universal-review; chmod +x ${HOME}/bin/universal-review; echo; echo "Successfully updated to v${NEWV}!";
fi
}


update() {
   new
   if [ "${BUILD}" == "${NEWB}" ]; then
      echo; echo "Already up to date (v${VERSION})"
   elif [[ "${BUILD}" != "${NEWB}" ]]; then
      ask_the_question
fi
}


uf() {
   new
   mv ${HOME}/.gerritpush/.new ${HOME}/bin/universal-review
   chmod +x ${HOME}/bin/universal-review
   echo "Forced update to v${NEWV}!"
}

saftey() {
		if [ -f ${HOME}/.gerritpush/safety ]; then
			TEMP=`cat ${HOME}/.gerritpush/safety`
			if [ ${TEMP == 1}; then
				DisplaySafety="On"
			else
				DisplaySafety="Off"
			fi
			
            echo ""
            echo "###################################################################"
            echo ""
            echo "Your Safety is set to: ${DisplaySafety}"
            echo ""
            echo "###################################################################"
            echo ""
        fi
		echo "Would you like to change Safety checks? (y/n)"
		read SAFE
		if [ "${SAFE}" == "y" ] || [ "${RESP}" == "Y" ]; then
			echo "By turning safety off your taking the rish of messing things up royally"
			echo
			echo "You do this at your own risk"
			echo
			echo "Turn On or Off ?"
			select safety1 in "On" "Off"; do
			case ${safety} in
				On ) rm -f ${HOME}/.gerritpush/safety; mkdir -p ${HOME}/.gerritpush; echo "1" > ${HOME}/.gerritpush/safety; break;;
				Off ) rm -f ${HOME}/.gerritpush/safety; mkdir -p ${HOME}/.gerritpush; echo "0" > ${HOME}/.gerritpush/safety; break;;
				* ) clear; echo "Invalid Entry ${safety1}, Please re-try"; echo; echo; saftey break ;;
			esac
		fi
			

install() {
		if [ ! -f ${HOME}/.gerritpush/safety ]; then
			mkdir -p ${HOME}/.gerritpush; echo "1" > ${HOME}/.gerritpush/safety;
		fi
        set_up_user
        team
}


error() {
echo "###################################################################"

if [ -f ${HOME}/.gerritpush/username ]; then
        DisplayUser=`cat ${HOME}/.gerritpush/username`
        echo "Your gerrit username is: ${DisplayUser}"
fi

if [ -f ${HOME}/.gerritpush/team ]; then
        DisplayCHOICE=`cat ${HOME}/.gerritpush/teamCHOICE`
        echo "Your gerrit team is set to: ${DisplayCHOICE}"
fi

if [ -f ${HOME}/.gerritpush/safety ]; then
        DisplaySafety=`cat ${HOME}/.gerritpush/safety`
        echo "Your Safety Checks are set to: ${DisplaySafety}"
fi
echo "###################################################################"
sleep 4; echo
echo ""
echo "###################################################################"
echo "#                      Universal Gerrit Push                      #"
echo "#                                                                 #"
echo "#       Created by Sniper/Goldflame09/wedgess/Papa Smurf151       #"
echo "#                                                                 #"
echo "#                                                                 #"
echo "###################################################################"
echo ""
echo ""
echo "###################################################################"
echo ""
        echo
        echo "Usage: universal-review [-short command]"
        echo "Or: universal-review [long command]"
        echo
        echo
        echo "###################################################################"
        echo
        echo " COMMANDS:"
        echo
        echo " install        (-in) --- Intital Setup"
        echo " team         (-nt) --- Change Team Gerrits"
        echo " add+push        (-ap) --- Add and push to gerrit"
        echo " amend         (-am) --- Amend the commit and push"
        echo " author        (-au) --- Change author of commit"
        echo " force        (-uf) --- Force the script to grab a new version"
        echo " name (-n) --- View or edit your gerrit username"
        echo " push         (-p) --- Push to gerrit"
        echo " sshkey         (-ssh) --- Create/show SSH key to put on Gerrit"
		echo " safety        (-sa) --- Toggle Safety checks on and off"
        echo " update         (-u) --- Check for, and download an update if one is available"
        echo
        echo "###################################################################"
        echo
        echo "If you encounter problems, check if:"
        echo " 1. Your gerrit username is correct (using the name option)"
        echo " 2. Your current branch is correct"
        echo " 3. Your public ssh key is attached to your gerrit profile"
        echo
        echo "If you still encounter problems, ask on the official PAC-man forum at:"
        echo "http://forum.pac-rom.com . . . . Press Control + Click to open URL"
        echo

}

install
clear

if [ ! -d ${HOME}/bin ]; then
        mkdir -p ${HOME}/bin
        echo "# Add ~/bin to PATH" >> ${HOME}/.bashrc
        echo "export PATH=${PATH}:~/bin" >> ${HOME}/.bashrc
fi


case $1 in
   -n|name)nameq_question;;
   -u|update)update;;
   -p|push)push;;
   -nt|team)new_team;;
   -in|install)install;;
   -ssh|sshkey)sshkey;;
   -ap|add+push)ap;;
   -sa|safety)safety;;
   -am|amend)amend;;
   -uf|force)uf;;
   -h|help|*)error;;
esac
