#!/bin/bash

###################################################################
# #
# Created by Sniper/Goldflame09/wedgess/Papa Smurf151 for PAC-man #
# #
###################################################################

VERSION=1.0
BUILD=1

# Variable matrix
TEAM=("AOKP" "Carbon" "Chameleon-OS" "CyanogenMod" "Dirty-Unicorns" "Gummy" "Omni" "Paraniod-Android" "PAC" "Vanir")
GTEAM=("gerrit.aokp.co" "review.carbon-rom.com" "review.chameleonos.org" "review.cyanogenmod.org" "gerrit.dirtyunicorns.com" "review.gummyrom.com" "gerrit.omnirom.org" "gerrit.paranoidandroid.co" "review.pac-rom.com" "vaniraosp.goo.im")
BRANCH1=("jb-mr2" "jb3" "jellybean-mr1" "cm-10.1" "jb-mr2" "jb4.3" "android-4.3" "jellybean" "cm-10.1" "jb")
BRANCH2=("jb-mr1" "jb2" "jellybean-mr2.1" "cm-10.2" "jb-mr1" "" "" "jb43" "cm-10.2" "jb42")
BRANCH3=("gh-pages" "" "" "" "du43" "" "" "gh-pages" "gh-pages" "jb42-master")
BRANCH4=("" "" "" "" "gh-pages" "" "" "" "" "jb43")
URL=(":29418/AOKP/" ":29418/CarbonDev/" ":29418/ChameleonOS/" ":29418/CyanogenMod/" ":29418/" ":29418/TEAM-Gummy/" ":29418/" ":29418/ParanoidAndroid/" ":29418/" ":29418/")

set_up_user(){
if [ -f ${HOME}/.gerritpush/username ]; then
   GUZER=`cat ${HOME}/.gerritpush/username`
else
   clear
   echo -n "Please enter your Gerrit UserName: "; read GUZER; clear
   echo "Your entered ${GUZER} is this correct"
   echo "Enter 1 for Yes or 2 for No"
   select correct1 in "Yes" "No"; do
   case ${correct1} in
        Yes ) mkdir -p ${HOME}/.gerritpush;
              echo ${GUZER} > ${HOME}/.gerritpush/username;
              clear; echo "Your new gerrit username is: ${GUZER}"; echo; break;;
        No ) clear; echo -n "Re-Enter Gerrit UserName: "; read GUZER; echo; mkdir -p ${HOME}/.gerritpush; echo ${GUZER} > ${HOME}/.gerritpush/username; clear; echo "Your new gerrit username is: ${GUZER}"; echo; break;;
        *) clear; echo "Invalid Entry ${correct1}, Please enter a number between [1 - 2]"; echo; set_up_user; break;;
   esac
 done
fi
}

team() {
        if [ -f ${HOME}/.gerritpush/team ]; then
                GTEAM=`cat ${HOME}/.gerritpush/team`
                TEAM=`cat ${HOME}/.gerritpush/teamCHOICE`
				if [ -f ${HOME}/.gerritpush/gerritURL ]; then
					GURL=`cat ${HOME}/.gerritpush/gerritURL`
				fi
        else
                new_team
        fi
}


new_team() {
                if [ -f ${HOME}/.gerritpush/team ]; then
                        DisplayTeam=`cat ${HOME}/.gerritpush/teamCHOICE`
                        echo ""
                        echo "###################################################################"
                        echo ""
                        echo "Your gerrit team is set to: ${DisplayTeam}"
                        echo ""
                        echo "###################################################################"
                        echo ""
                fi
                echo "Please Select your new Gerrit Team:"
                echo "Enter the Corresponding Number"
                select NUMBER in $(echo ${TEAM[@]}); do
                	case ${NUMBER} in
							AOKP) i=0; break;;
                        	Carbon) i=1; break;;
                        	Chameleon-OS) i=2; break;;
                        	CyanogenMod) i=3; break;;
                        	Dirty-Unicorns) i=4; break;;
                        	Gummy) i=5; break;;
                        	Omni) i=6; break;;
                        	Paranoid-Android) i=7; break;;
                        	PAC) i=8; break;;
                        	Vanir) i=9; break;;
                        	*) echo "Invalid Entry ${NUMBER}, Please enter from the options provided."; echo; echo; team; break;;
                	esac
                done
        rm -f ${HOME}/.gerritpush/team
        rm -f ${HOME}/.gerritpush/teamCHOICE
        rm -f ${HOME}/.gerritpush/projectNAME
        rm -f ${HOME}/.gerritpush/gerritURL
        mkdir -p ${HOME}/.gerritpush; echo ${GTEAM[$i]} > ${HOME}/.gerritpush/team;
        mkdir -p ${HOME}/.gerritpush; echo ${TEAM[$i]} > ${HOME}/.gerritpush/teamCHOICE;
        mkdir -p ${HOME}/.gerritpush; echo ${URL[$i]} > ${HOME}/.gerritpush/gerritURL;
	sleep 2;echo
        clear; echo "Default Set to ${TEAM}"; echo
        rm ${HOME}/.gerritpush/branch > /dev/null 2>&1
        new_branch
}


branch() {
        if [ -f ${HOME}/.gerritpush/branch ]; then
                BRANCH=`cat ${HOME}/.gerritpush/branch`
        else
                new_branch
        fi
}


new_branch() {
        if [ -f ${HOME}/.gerritpush/branch ]; then
                DisplayBranch1=`cat ${HOME}/.gerritpush/branch`
                echo ""
                echo "###################################################################"
                echo ""
                echo "Your current branch is set to: ${DisplayBranch1}"
                echo ""
                echo "###################################################################"
                echo ""
        fi
        team
        rm -f ${HOME}/.gerritpush/branch
	echo "Please enter the branch you want to upload to:"
	echo "GH-PAGES is ONLY for SwagPapers, PacPapers, or DirtWalls!!"

	select BRANCH in "${BRANCH1[$i]}" "${BRANCH2[$i]}" "${BRANCH3[$i]}" "${BRANCH4[$i]}"; do
        	if [ -z $(echo "$BRANCH") ]; then 
			echo "Invalid Entry"
                        new_branch
                        echo "" 
                        echo ""
		fi
        	break
	done
        echo ${BRANCH} > ${HOME}/.gerritpush/branch
	echo ""
	echo "Your new current branch is: $BRANCH"
	echo ""
}


correct_commit() {
clear; echo ${MSSG}; echo
echo "Is this correct ??"
echo "Enter 1 for Yes and 2 for No"
  select correct2 in "Yes" "No"; do
   case ${correct2} in
        Yes ) echo "Commit set to ${MSSG}"; break;;
        No ) echo "Re-enter commit message"; read MSSG; break;;
        * ) clear; echo "Invalid Entry ${correct2}, Please re-try"; echo; echo; correct_commit; break ;;
   esac
  done
}


push() {
echo -n "Are you sure you want to push? (y/n): "; read RESP
if [ "${RESP}" == "y" ] || [ "${RESP}" == "Y" ]; then
        if [ -f ${HOME}/.gerritpush/branch ]; then
           echo "Current branch: `cat ${HOME}/.gerritpush/branch`"
           echo -n "Push to current branch? (y/n): "; read CTPUSH
                  if [ "${CTPUSH}" == "y" ] || [ "${CTPUSH}" == "Y" ]; then
                        GUZER=`cat ${HOME}/.gerritpush/username`
						GTEAM=`cat ${HOME}/.gerritpush/team`
						BRANCH=`cat ${HOME}/.gerritpush/branch`
                        GURL=`cat ${HOME}/.gerritpush/gerritURL`
						
						PROJECT=`grep "projectname" .git/config | awk -F"projectname = " '{print $2}' | sed -e 's/^[ \t]*//' `
						if [ -z ${PROJECT} ]; then
							PROJECT=`grep "url" .git/config | awk -F"url = " '{print $2}' | rev | cut -d/ -f1 | rev | cut -d. -f1`
						fi
                        git push ssh://${GUZER}@${GTEAM}${GURL}${PROJECT} HEAD:refs/\for/${BRANCH}
                  else
                        new_branch
                  fi
        else
         new_branch
        fi
else
  echo "Canceled"
fi
}


ap() {
git add -A
scp -p -P 29418 ${GUZER}@${GTEAM}:hooks/commit-msg .git/hooks/
   echo "Add commit message below.
--------------------------"
   read MSSG
   correct_commit
git commit -a -m "${MSSG}"
push
}


amend() {
   echo -n "Have you edited the files?/Do you want to change commit message? (y/n):"; read RESPa
if [ "${RESPa}" == "y" ] || [ "${RESPa}" == "Y" ]; then
   git add -A
   git commit --amend
   push
elif [ "${RESPa}" == "n" ] || [ "${RESPa}" == "N" ]; then
        echo "Please edit them"
        echo "Press 1 after you edit them"
        read amend1
        if [ ${amend1} == "1" ]; then
                git add -A
                git commit --amend
                push
        else
                echo "Take your time and come back when you are ready"
        fi
fi
}


author() {
echo "Please enter username of author"
echo -n "Username: "
read auser
git commit --amend --author ${auser}
}


correct_gname() {
echo "Your entered ${GUZER} is this correct?"
echo "Enter 1 for Yes and 2 for No"
   select correct1 in "Yes" "No"; do
   case ${correct1} in
        Yes ) mkdir ${HOME}/.gerritpush; echo ${GUZER} > ${HOME}/.gerritpush/username; echo "Your new gerrit username is: ${GUZER}"; break;;
        No ) echo -n "Re-Enter Gerrit UserName: "; read GUZER; echo; mkdir -p ${HOME}/.gerritpush; echo ${GUZER} > ${HOME}/.gerritpush/username; echo "Your new gerrit username is: ${GUZER}"; break;;
        * ) clear; echo "Invalid Entry ${correct1}, Please re-try"; echo; echo; correct_gname break ;;
   esac
  done
}


nameq_question() {
echo "Enter an option:"
echo " 1. View your current gerrit username"
echo " 2. Enter a new gerrit username"
  select NAME in "View" "New"; do
   case ${NAME} in
       View ) if [ -f ${HOME}/.gerritpush/username ]; then
           echo "Your current gerrit username is: ${GUZER}";
         else
         echo "No gerrit username found..";
         fi; break;;
      New ) echo -n "Enter your new gerrit username: "; read GUZER; correct_gname; break;;
      * ) echo "${NAME} is not a valid option (Choose 1 or 2)"; nameq_question; break;;
   esac
  done
}


sshkey() {
team
echo ""
echo "Your gerrit team is set to: ${TEAM}"
echo ""
echo "You will have to set this up for every Team's Gerrit"
echo "But can use the same sshkeys for all"
echo ""
if [ -e ${HOME}/.ssh/id_rsa.pub ]; then
   echo "SSH Key already exists.

Go to ${TEAM} Gerrit (${GTEAM}), sign in, go to settings,
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open ${HOME}/.ssh/id_rsa.pub
else
   ssh-keygen
   echo "Go to ${TEAM} Gerrit (${GTEAM}), sign in, go to settings,
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open ${HOME}/.ssh/id_rsa.pub
fi
}


new() {
   curl http:/pac-rom.com/downloads/universal-review > ${HOME}/.gerritpush/.new
   sed -i '12,132d' ${HOME}/.gerritpush/.new
   NEWB=`grep BUILD= ${HOME}/.gerritpush/.new | sed "s/BUILD=//g"`
   NEWV=`grep VERSION= ${HOME}/.gerritpush/.new | sed "s/VERSION=//g"`
}

ask_the_question() {
echo -n "Are you sure you want to update to version: ${NEWV} build: ${NEWB}? (yes/no)"
select correct4 in "Yes" "No"; do
  case ${correct4} in
      Yes ) rm -f ${HOME}/.gerritpush/universal-review; mv ${HOME}/.gerritpush/.new ${HOME}/bin/universal-review; chmod +x ${HOME}/bin/universal-review; echo; echo "Successfully updated to v${NEWV}!"; break;;
      No ) echo "Update canceled"; break ;;
      * ) clear; echo "Invalid option ${correct4}, Please try again..."; echo; ask_the_question; break;;
   esac
done
}


update() {
   new
   if [ "${BUILD}" == "${NEWB}" ]; then
      echo; echo "Already up to date (v${VERSION})"
   elif [[ "${BUILD}" != "${NEWB}" ]]; then
      ask_the_question
fi
}


uf() {
   new
   mv ${HOME}/.gerritpush/.new ${HOME}/bin/universal-review
   chmod +x ${HOME}/bin/universal-review
   echo "Forced update to v${NEWV}!"
}


install() {
        set_up_user
        team
        branch
}


error() {
echo "###################################################################"

if [ -f ${HOME}/.gerritpush/username ]; then
        DisplayUser=`cat ${HOME}/.gerritpush/username`
        echo "Your gerrit username is: ${DisplayUser}"
fi

if [ -f ${HOME}/.gerritpush/team ]; then
        DisplayCHOICE=`cat ${HOME}/.gerritpush/teamCHOICE`
        echo "Your gerrit team is set to: ${DisplayCHOICE}"
fi

if [ -f ${HOME}/.gerritpush/branch ]; then
        DisplayBranch=`cat ${HOME}/.gerritpush/branch`
        echo "Your current branch is set to: ${DisplayBranch}"
fi
echo "###################################################################"
sleep 4; echo
echo ""
echo "###################################################################"
echo "#                      Universal Gerrit Push                      #"
echo "#                                                                 #"
echo "#       Created by Sniper/Goldflame09/wedgess/Papa Smurf151       #"
echo "#                                                                 #"
echo "#                                                                 #"
echo "###################################################################"
echo ""
echo ""
echo "###################################################################"
echo ""
        echo
        echo "Usage: universal-review [-short command]"
        echo "Or: universal-review [long command]"
        echo
        echo
        echo "###################################################################"
        echo
        echo " COMMANDS:"
        echo
        echo " install        (-in) --- Intital Setup"
        echo " team         (-nt) --- Change Team Gerrits"
        echo " add+push        (-ap) --- Add and push to gerrit"
        echo " amend         (-am) --- Amend the commit and push"
        echo " author        (-au) --- Change author of commit"
        echo " force        (-uf) --- Force the script to grab a new version"
        echo " name (-n) --- View or edit your gerrit username"
        echo " branch        (-nb) --- Choose a new branch to push to"
        echo " push         (-p) --- Push to gerrit"
        echo " sshkey         (-ssh) --- Create/show SSH key to put on Gerrit"
        echo " update         (-u) --- Check for, and download an update if one is available"
        echo
        echo "###################################################################"
        echo
        echo "If you encounter problems, check if:"
        echo " 1. Your gerrit username is correct (using the name option)"
        echo " 2. Your current branch is correct"
        echo " 3. Your public ssh key is attached to your gerrit profile"
        echo
        echo "If you still encounter problems, ask on the official PAC-man forum at:"
        echo "http://forum.pac-rom.com . . . . Press Control + Click to open URL"
        echo

}

install
clear

if [ ! -d ${HOME}/bin ]; then
        mkdir -p ${HOME}/bin
        echo "# Add ~/bin to PATH" >> ${HOME}/.bashrc
        echo "export PATH=${PATH}:~/bin" >> ${HOME}/.bashrc
fi


case $1 in
   -n|name)nameq_question;;
   -nb|branch)new_branch;;
   -u|update)update;;
   -p|push)push;;
   -nt|team)new_team;;
   -in|install)install;;
   -ssh|sshkey)sshkey;;
   -ap|add+push)ap;;
   -am|amend)amend;;
   -uf|force)uf;;
   -h|help|*)error;;
esac
