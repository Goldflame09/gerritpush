#!/bin/bash

#############################################
#                                           #
# Created by Sniper/Goldflame09 for PAC-man #
#                                           #
#############################################

VERSION=0.9
BUILD=9

if [ -e ~/.pac/username ]; then
   USER=$(cat ~/.pac/username)
else
   echo "Please enter your gerrit username:
----------------------------------"
   read USER
   mkdir ~/.pac
   echo $USER > ~/.pac/username
   USER=$(cat ~/.pac/username)
   echo "Your new gerrit username is: $(cat ~/.pac/username)"
fi

TYPE="$1"
ap () {
   git add -A
   echo "Add commit message below.
-------------------------"
   read MSSG
   git commit -a -m "$MSSG"
   push
}

push () {
 read -p "Are you sure you want to push? (y/n):" RESP
if [ "$RESP" = "y" ]; then
   rm -rf ~/.pac/branch
   echo "Please enter the branch you want to upload to (ex. cm-10.2):
------------------------------------------------------------"
   read BRANCH
   echo $BRANCH > ~/.pac/branch
   BRANCH=$(cat ~/.pac/branch)
   echo "Your new current branch is: $(cat ~/.pac/branch)"
   PROJECT=$(grep PAC-man .git/config | awk -F/ '{print $NF}')
   git push ssh://$USER@review.pac-rom.com:29418/$PROJECT HEAD:refs/\for/$BRANCH
else
  echo "Canceled"
fi
}

hooks () {
echo "Adding Commit-ID"
   scp -p -P 29418 $USER@review.pac-rom.com:hooks/commit-msg .git/hooks/
   git commit --amend
read -p "Is the Change-ID there? (y/n):" RESPc
case $RESPc in
   y) push ;;
   n) scp -p -P 29418 $USER@review.pac-rom.com:hooks/commit-msg .git/hooks/
   git commit --amend
read -p "Is the Change-ID there? (y/n):" RESPe
case $RESPe in
   y) push ;;
   n) echo "then please run: 
{scp -p -P 29418 $USER@review.pac-rom.com:hooks/commit-msg .git/hooks/} 
as something is not working" ;;
   *) echo "Canceled"
esac ;;
   *) echo "Canceled" ;;
esac
}

amend () {
   read -p "Have you edited the files?/Do you want to change commit message? (y/n):" RESPa
if [ "$RESPa" = "y" ]; then
   git add -A
   git commit --amend
   push
else
   echo "Please edit them"
fi
}

name () {
   echo "Enter an option:"
   echo "   1. View your current gerrit username"
   echo "   2. Enter a new gerrit username"
   read NAME
   case $NAME in
      1|1.)
         echo "Your current gerrit username is: $(cat ~/.pac/username)";;
      2|2.)
         echo "Enter your new gerrit username:
-------------------------------"
         read USER
         echo $USER > ~/.pac/username
         USER=$(cat ~/.pac/username)
         echo "Your new gerrit username is: $(cat ~/.pac/username)";;
      *) echo "You did not choose a valid option (1 or 2)";;
   esac
}

sshkey () {
if [ -e ~/.ssh/id_rsa.pub ]; then
   echo "SSH Key already exists.

Go to PAC Gerrit (http://review.pac-rom.com), sign in, go to settings, 
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open .ssh/id_rsa.pub
else
   ssh-keygen
   echo "Go to PAC Gerrit (http://review.pac-rom.com), sign in, go to settings, 
and click on SSH Public Keys. Use Control + Click to open URL.

Click on add SSH Key and copy and paste contents of file from .ssh/id_rsa.pub."
read -p "Press [Enter] to open file..."
   gnome-open .ssh/id_rsa.pub
fi
}

new () {
   cd ~/.pac
   curl http://pac-rom.com/downloads/pac-review > .new
   sed -e '12,132d' .new > .tmp
   NEWB=$(grep BUILD= .tmp | sed "s/BUILD=//g")
   NEWV=$(grep VERSION= .tmp | sed "s/VERSION=//g")
}

update () {
   new
   if [ $BUILD = "$NEWB" ]
   then
      echo "Already up to date (v$VERSION)"
   elif [ "$BUILD" -lt "$NEWB" ]
   then
      cp .new ~/bin/pac-review
      echo "Successfully updated to v$NEWV!"
   else
      echo "You Cheated!"
   fi
   rm .new .tmp
}

uf () {
   new
   cp .new ~/bin/pac-review
   rm .new
   echo "Forced update to v$NEWV!"
}

error () {
   echo " "
   echo "Usage: pac-review [-short command]"
   echo "Or:    pac-review [long comand]"
   echo " "
   echo "Commands:"
   echo "   add+push   	(-ap)  --- Add and push to gerrit"
   echo "   amend  	(-am)  --- Amend the commit and push"
   echo "   force	(-uf)  --- Force the script to grab a new version"
   echo "   hooks 	(-scp) --- Generate Change-ID for commit"
   echo "   name   	(-n)   --- View or edit your gerrit username"
   echo "   push   	(-p)   --- Push to gerrit"
   echo "   sshkey 	(-ssh) --- Create/show SSH key to put on Gerrit"
   echo "   update 	(-u)   --- Check for, and download an update if one is available"
   echo " "
   echo "If you encounter problems, check if:"
   echo "   1. Your gerrit username is correct (using the name option)"
   echo "   2. Your current branch is correct"
   echo "   3. Your public ssh key is attached to your gerrit profile"
   echo " "
   echo "If you still encounter problems, ask on the official PAC-man forum at:"
   echo "http://forum.pac-rom.com . . . . Press Control + Click to open URL"

}

case $TYPE in
   -n|name)name;;
   -u|update)update;;
   -p|push)push;;
   -scp|hooks)hooks;;
   -ssh|sshkey)sshkey;;
   -h|help)error;;
   -help|help)error;;
   -ap|add+push)ap;;
   -am|amend)amend;;
   -uf|force)uf;;
   *|help)error;;
esac
